# kuin_scene1

シーン毎の動的ロードを行うサンプル

## 作者

若草春男(twitter: @HaruoWakakusa)

## デバッグ環境

kuin_2018_09_17

Windows 10 Pro 64bit版

## 概要

ゲームプログラミングにおいてアセット（画像、音声データなど）のロードは課題の一つである。アセットのサイズが大きくなった場合にはゲーム開始時にすべてのアセットをロードするとロード時間がかかるという問題が発生する。また、画面遷移時に前画面のアセットデータがプログラム中に保持されたままになっている場合、余分なメモリを消費する。さらに、正しくメモリ確保／解放が行われなかった場合、画面遷移をするたびにメモリリークが発生することになる。このサンプルでは画面遷移毎に正しく動的ロードを行う方法を提示する。

## 画面設計

- シーンは３つ用意しており、画面をクリックすることでシーンが遷移します。
- アセットの非同期ロード機能を実験的に実装しています。
- フェードイン・フェードアウトは実装していません。

## パフォーマンス

- Kuinエディタで[コンパイル & 実行]した時よりも[リリースビルド...]で出力されたパッケージを実行するほうが高速に実行されます。
- 各シーンでロードされる画像ファイルはそれほど重いものではありませんが、体感できるくらい遅いことが分かるかと思います。
- 画像のロード時間が遅くならないようにするには、表示画面に合わせて画像解像度を調整する必要があるかと思います。ロード時間だけに関して言えば、画面のピクセルと画像解像度を正確に合わせる必要はありません。だいたい合っていればよいものと思います。（逆にサンプルではわざと画面に対して解像度が高い画像をロードさせている）

## プログラム設計

- Sceneクラスというクラスを定義していますが、単に各シーンクラス(Scene1, Scene2, Scene3)のインターフェースを合わせるために用意しており、Sceneクラス自体は今回のサンプルでは使用していません。
- Kuinのwnd@act()関数ではその返り値でウィンドウが閉じられたかを判別します。このサンプルではウィンドウが閉じられているかどうかの情報をグローバルに共有したかったので別途@act()関数を用意して@isAlive変数にwnd@act()の返り値を保持するようにしています。
- 今回のサンプルではrun()メソッドの中にload()メソッド、unload()メソッドの中身を記述してもよかったのですが、オブジェクトを生成するコードとオブジェクトを破棄するコードを隣り合わせにしたかったのでそれらをload(), unload()メソッドに抜き出しています。
- 普通であれば画面遷移の度にシーンオブジェクトを生成すべきですが、Kuin言語は参照カウント方式を採用しており、シーンオブジェクト内で循環参照が生じていた時にアセットオブジェクトも破棄できなくなる可能性があると考えました。従って、全てのシーンオブジェクトはアプリ起動時に生成し、アプリ終了時に破棄されるようになっています。
- サンプル内の３つのシーンオブジェクトは非常に似た記述になっており、Sceneクラスに機能を統合することもできたのですが、実際のシーン（画面）は、メインメニュー画面・マップ画面・戦闘画面など、ある程度異なる振る舞いをすると考えたのであえて冗長な記述にしています。
- Kuin言語には明確にオブジェクトの解放を行う関数・メソッドが用意されていないので、オブジェクトを参照している変数にnullを代入することで解放しています。
